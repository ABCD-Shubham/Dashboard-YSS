<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
        
        .backdrop-blur-md {
            backdrop-filter: blur(12px);
        }
        
        .bg-gradient-to-br {
            background: linear-gradient(to bottom right, var(--tw-gradient-stops));
        }
        
        .bg-gradient-to-r {
            background: linear-gradient(to right, var(--tw-gradient-stops));
        }
        
        .from-slate-50 { --tw-gradient-from: #f8fafc; }
        .via-blue-50 { --tw-gradient-to: #eff6ff; }
        .to-indigo-50 { --tw-gradient-stops: var(--tw-gradient-from), #eef2ff var(--tw-gradient-to, #eef2ff); }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .transform {
            transform: translateZ(0);
        }
        
        .hover\:scale-105:hover {
            transform: scale(1.05);
        }
        
        .hover\:-translate-y-1:hover {
            transform: translateY(-0.25rem);
        }
        
        .hover\:-translate-y-2:hover {
            transform: translateY(-0.5rem);
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }
        
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .bg-white\/70 {
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .bg-white\/80 {
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .border-white\/20 {
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .text-transparent {
            color: transparent;
        }
        
        .bg-clip-text {
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .drop-zone {
            border: 2px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        /* Custom scrollbar styles */
        .kanban-drop-zone::-webkit-scrollbar {
            width: 6px;
        }

        .kanban-drop-zone::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .kanban-drop-zone::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .kanban-drop-zone::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .kanban-column {
                min-width: 100%;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .kanban-column {
                min-width: 300px;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .toast.warning {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <!-- Loading Screen -->
    <div id="loading" class="min-h-screen bg-gray-50 flex items-center justify-center">
        <div class="flex items-center space-x-2">
            <i data-lucide="refresh-cw" class="w-6 h-6 animate-spin text-blue-500"></i>
            <span class="text-lg text-gray-600">Loading dashboard...</span>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <div class="bg-white/80 backdrop-blur-md shadow-lg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <div class="p-2 bg-gradient-to-r from-red-500 to-pink-500 rounded-xl shadow-lg">
                            <i data-lucide="flame" class="w-8 h-8 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">
                                Lead Tracker
                            </h1>
                            <p class="text-sm text-gray-500">Multi-Channel Lead Intelligence</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <button id="gridViewBtn" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors bg-blue-500 text-white">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                                <span>Grid</span>
                            </button>
                            <button id="kanbanViewBtn" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors text-gray-600 hover:bg-gray-50">
                                <i data-lucide="columns" class="w-4 h-4"></i>
                                <span>Kanban</span>
                            </button>
                        </div>
                        <button id="refreshBtn" class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl hover:from-blue-600 hover:to-indigo-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div id="statsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Stats cards will be populated by JavaScript -->
            </div>

            <!-- Charts and Rules Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Channel Distribution Chart -->
                <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-8">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="p-2 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-lg">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-white"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Channel Distribution</h2>
                    </div>
                    <div class="h-80">
                        <canvas id="channelChart"></canvas>
                    </div>
                </div>

                <!-- Scoring Rules -->
                <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="p-2 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-lg">
                            <i data-lucide="target" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Scoring Rules</h3>
                            <p class="text-sm text-gray-600">How lead scores are calculated</p>
                        </div>
                    </div>
                    <div id="scoringRules" class="space-y-3">
                        <!-- Scoring rules will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="p-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg">
                            <i data-lucide="filter" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="flex space-x-2">
                            <button class="filter-btn active px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg transform scale-105" data-filter="all">All</button>
                            <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 hover:scale-105" data-filter="hot">Hot</button>
                            <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 hover:scale-105" data-filter="warm">Warm</button>
                            <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 hover:scale-105" data-filter="cold">Cold</button>
                        </div>
                    </div>
                    <div class="relative">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
                        <input id="searchInput" type="text" placeholder="Search leads..." class="pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white/80 backdrop-blur-sm shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div id="gridView" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Lead cards will be populated by JavaScript -->
            </div>

            <div id="kanbanView" class="hidden">
                <div class="flex space-x-6 overflow-x-auto pb-6">
                    <!-- Kanban columns will be populated by JavaScript -->
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center py-16">
                <div class="p-4 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                    <i data-lucide="users" class="w-12 h-12 text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">No leads found</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    Try adjusting your search terms or filters.
                </p>
            </div>
        </div>
    </div>

    <!-- Activity History Modal -->
    <div id="activityModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-lg">
                        <i data-lucide="history" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Activity History</h3>
                        <p id="modalLeadName" class="text-sm text-gray-600"></p>
                    </div>
                </div>
                <button id="closeModal" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="modalContent">
                    <!-- Modal content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Sample data - replacing API calls
        const sampleData = {
            leads: [         
       {
                    id: 1,
                    name: "Sarah Johnson",
                    email: "sarah.johnson@email.com",
                    phone: "+1 (555) 123-4567",
                    source: "Instagram",
                    created_at: "2025-11-01T10:30:00Z",
                    last_contact: "2025-11-05T14:22:00Z",
                    score: 45,
                    category: "hot",
                    suggested_action: "Schedule a follow-up call within 24 hours. High engagement on recent posts.",
                    score_breakdown: [
                        {
                            rule: "email_engagement",
                            points: 12,
                            description: "Email engagement (3+ opens)",
                            count: 4,
                            activities: [
                                { channel: "email", action: "email_opened", timestamp: "2025-11-05T09:15:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "dm_activity",
                            points: 15,
                            description: "DM activity in last 3 days",
                            count: 2,
                            activities: [
                                { channel: "instagram_dm", action: "message_sent", timestamp: "2025-11-04T16:30:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "booking_click",
                            points: 20,
                            description: "Booking link clicked",
                            count: 1,
                            activities: [
                                { channel: "email", action: "booking_link_clicked", timestamp: "2025-11-05T11:45:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "email", action: "booking_link_clicked", timestamp: "2025-11-05T11:45:00Z", details: {} },
                        { channel: "instagram_dm", action: "message_sent", timestamp: "2025-11-04T16:30:00Z", details: {} },
                        { channel: "email", action: "email_opened", timestamp: "2025-11-04T09:15:00Z", details: {} },
                        { channel: "instagram", action: "post_liked", timestamp: "2025-11-03T20:22:00Z", details: {} }
                    ]
                },
                {
                    id: 2,
                    name: "Michael Chen",
                    email: "m.chen@techcorp.com",
                    phone: "+1 (555) 987-6543",
                    source: "Email",
                    created_at: "2025-11-01T08:15:00Z",
                    last_contact: "2025-11-04T10:30:00Z",
                    score: 32,
                    category: "warm",
                    suggested_action: "Send personalized follow-up email with case studies relevant to tech industry.",
                    score_breakdown: [
                        {
                            rule: "email_engagement",
                            points: 12,
                            description: "Email engagement (3+ opens)",
                            count: 3,
                            activities: [
                                { channel: "email", action: "email_opened", timestamp: "2025-11-04T10:30:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "social_engagement",
                            points: 8,
                            description: "Social engagement (2+ posts)",
                            count: 3,
                            activities: [
                                { channel: "instagram", action: "post_liked", timestamp: "2025-11-03T15:20:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "recent_activity",
                            points: 5,
                            description: "Recent activity bonus (24h)",
                            count: 1,
                            activities: [
                                { channel: "email", action: "email_opened", timestamp: "2025-11-04T10:30:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "email", action: "email_opened", timestamp: "2025-11-04T10:30:00Z", details: {} },
                        { channel: "instagram", action: "post_liked", timestamp: "2025-11-03T15:20:00Z", details: {} },
                        { channel: "email", action: "email_opened", timestamp: "2025-11-02T14:10:00Z", details: {} }
                    ]
                },
                {
                    id: 3,
                    name: "Emma Rodriguez",
                    email: "emma.r@startup.io",
                    phone: "+1 (555) 456-7890",
                    source: "WhatsApp",
                    created_at: "2025-11-02T16:45:00Z",
                    last_contact: "2025-11-05T09:15:00Z",
                    score: 28,
                    category: "warm",
                    suggested_action: "Continue nurturing with valuable content. Consider offering a free consultation.",
                    score_breakdown: [
                        {
                            rule: "dm_activity",
                            points: 15,
                            description: "DM activity in last 3 days",
                            count: 1,
                            activities: [
                                { channel: "whatsapp", action: "message_received", timestamp: "2025-11-04T09:15:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "email_engagement",
                            points: 10,
                            description: "Email opened in last 3 days",
                            count: 2,
                            activities: [
                                { channel: "email", action: "email_opened", timestamp: "2025-11-04T13:22:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "whatsapp", action: "message_received", timestamp: "2025-11-05T09:15:00Z", details: {} },
                        { channel: "email", action: "email_opened", timestamp: "2025-11-04T13:22:00Z", details: {} },
                        { channel: "whatsapp", action: "message_sent", timestamp: "2025-11-03T11:30:00Z", details: {} }
                    ]
                },
                {
                    id: 4,
                    name: "David Kim",
                    email: "david.kim@consulting.com",
                    phone: "+1 (555) 321-0987",
                    source: "Beehive",
                    created_at: "2025-11-01T12:00:00Z",
                    last_contact: "2025-11-03T16:45:00Z",
                    score: 18,
                    category: "cold",
                    suggested_action: "Re-engage with educational content. Consider a different communication channel.",
                    score_breakdown: [
                        {
                            rule: "email_engagement",
                            points: 10,
                            description: "Email opened in last 3 days",
                            count: 1,
                            activities: [
                                { channel: "beehive", action: "email_opened", timestamp: "2025-11-03T16:45:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "social_engagement",
                            points: 8,
                            description: "Social engagement (2+ posts)",
                            count: 2,
                            activities: [
                                { channel: "instagram", action: "post_viewed", timestamp: "2025-11-02T19:20:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "beehive", action: "email_opened", timestamp: "2025-11-03T16:45:00Z", details: {} },
                        { channel: "instagram", action: "post_viewed", timestamp: "2025-11-02T19:20:00Z", details: {} },
                        { channel: "email", action: "email_sent", timestamp: "2025-11-01T10:00:00Z", details: {} }
                    ]
                },
                {
                    id: 5,
                    name: "Lisa Thompson",
                    email: "lisa.thompson@agency.com",
                    phone: "+1 (555) 654-3210",
                    source: "HighLevel",
                    created_at: "2025-11-02T09:30:00Z",
                    last_contact: "2025-11-05T11:20:00Z",
                    score: 42,
                    category: "hot",
                    suggested_action: "Immediate follow-up required. High intent signals detected.",
                    score_breakdown: [
                        {
                            rule: "booking_click",
                            points: 20,
                            description: "Booking link clicked",
                            count: 1,
                            activities: [
                                { channel: "highlevel", action: "booking_link_clicked", timestamp: "2025-11-05T11:20:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "dm_activity",
                            points: 15,
                            description: "DM activity in last 3 days",
                            count: 1,
                            activities: [
                                { channel: "highlevel", action: "form_submitted", timestamp: "2025-11-05T10:15:00Z", details: {} }
                            ]
                        },
                        {
                            rule: "recent_activity",
                            points: 5,
                            description: "Recent activity bonus (24h)",
                            count: 2,
                            activities: [
                                { channel: "highlevel", action: "booking_link_clicked", timestamp: "2025-11-05T11:20:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "highlevel", action: "booking_link_clicked", timestamp: "2025-11-05T11:20:00Z", details: {} },
                        { channel: "highlevel", action: "form_submitted", timestamp: "2025-11-05T10:15:00Z", details: {} },
                        { channel: "email", action: "email_opened", timestamp: "2025-11-04T15:30:00Z", details: {} }
                    ]
                },
                {
                    id: 6,
                    name: "Robert Wilson",
                    email: "r.wilson@finance.com",
                    phone: "+1 (555) 789-0123",
                    source: "Instagram",
                    created_at: "2025-11-01T14:20:00Z",
                    last_contact: "2025-11-02T08:45:00Z",
                    score: 15,
                    category: "cold",
                    suggested_action: "Consider automated nurture sequence. Low engagement pattern.",
                    score_breakdown: [
                        {
                            rule: "social_engagement",
                            points: 8,
                            description: "Social engagement (2+ posts)",
                            count: 2,
                            activities: [
                                { channel: "instagram", action: "post_viewed", timestamp: "2025-11-02T08:45:00Z", details: {} }
                            ]
                        }
                    ],
                    recent_activities: [
                        { channel: "instagram", action: "post_viewed", timestamp: "2025-11-02T08:45:00Z", details: {} },
                        { channel: "email", action: "email_sent", timestamp: "2025-11-01T12:00:00Z", details: {} },
                        { channel: "instagram", action: "profile_visited", timestamp: "2025-11-01T16:30:00Z", details: {} }
                    ]
                }
            ],
            stats: {
                total_leads: 6,
                hot_leads: 2,
                warm_leads: 2,
                cold_leads: 2,
                channel_distribution: {
                    email: 8,
                    beehive: 3,
                    instagram: 6,
                    instagram_dm: 2,
                    whatsapp: 3,
                    highlevel: 4
                },
                top_hot_leads: [],
                recent_activities: []
            }
        };

        // Global state
        let currentFilter = 'all';
        let currentSearch = '';
        let currentView = 'grid';
        let leads = [...sampleData.leads];
        let stats = { ...sampleData.stats };

        // Utility functions
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d ago`;
        }

        function getCategoryIcon(category) {
            const icons = {
                hot: 'flame',
                warm: 'thermometer',
                cold: 'snowflake'
            };
            return icons[category] || 'circle';
        }

        function getCategoryGradient(category) {
            const gradients = {
                hot: 'from-red-500 to-pink-500',
                warm: 'from-yellow-500 to-orange-500',
                cold: 'from-gray-500 to-slate-500'
            };
            return gradients[category] || 'from-gray-500 to-slate-500';
        }

        function getChannelIcon(channel) {
            const icons = {
                email: 'mail',
                beehive: 'mail',
                whatsapp: 'message-circle',
                instagram: 'instagram',
                instagram_dm: 'instagram',
                highlevel: 'calendar'
            };
            return icons[channel] || 'message-circle';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Render functions
        function renderStatsCards() {
            const container = document.getElementById('statsCards');
            const statsConfig = [
                { title: 'Total Leads', value: stats.total_leads, icon: 'users', gradient: 'from-blue-500 to-cyan-500' },
                { title: 'Hot Leads', value: stats.hot_leads, icon: 'flame', gradient: 'from-red-500 to-pink-500' },
                { title: 'Warm Leads', value: stats.warm_leads, icon: 'thermometer', gradient: 'from-yellow-500 to-orange-500' },
                { title: 'Cold Leads', value: stats.cold_leads, icon: 'snowflake', gradient: 'from-gray-500 to-slate-500' }
            ];

            container.innerHTML = statsConfig.map(stat => `
                <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">${stat.title}</p>
                            <p class="text-4xl font-bold text-gray-900 mt-2">${stat.value}</p>
                            <div class="mt-3 flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full bg-gradient-to-r ${stat.gradient}" style="width: ${Math.min(100, (stat.value / 20) * 100)}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 rounded-2xl bg-gradient-to-r ${stat.gradient} shadow-lg">
                            <i data-lucide="${stat.icon}" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function renderChannelChart() {
            const ctx = document.getElementById('channelChart').getContext('2d');
            const data = stats.channel_distribution;
            
            // Calculate total activities for percentage calculation
            const totalActivities = Object.values(data).reduce((sum, count) => sum + count, 0);
            
            const colors = {
                email: '#3b82f6',
                beehive: '#10b981',
                instagram: '#e91e63',
                instagram_dm: '#f59e0b',
                whatsapp: '#25d366',
                highlevel: '#8b5cf6'
            };

            // Create clean channel names
            const channelNames = Object.keys(data).map(key => key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: channelNames,
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.keys(data).map(key => colors[key] || '#6b7280'),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / totalActivities) * 100).toFixed(0);
                                    return `${context.label}: ${percentage}%`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: function(context) {
                                // Use contrasting colors for better visibility
                                const bgColor = context.dataset.backgroundColor[context.dataIndex];
                                return bgColor;
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value, context) {
                                const percentage = ((value / totalActivities) * 100).toFixed(0);
                                const label = context.chart.data.labels[context.dataIndex];
                                return `${label} ${percentage}%`;
                            },
                            anchor: 'end',
                            align: 'end',
                            offset: 10,
                            clip: false
                        }
                    },
                    layout: {
                        padding: {
                            top: 40,
                            bottom: 40,
                            left: 60,
                            right: 60
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const data = chart.data;
                        const dataset = data.datasets[0];
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                        
                        // Store label positions to avoid overlaps
                        const labelPositions = [];
                        
                        chart.getDatasetMeta(0).data.forEach((arc, index) => {
                            const percentage = ((dataset.data[index] / totalActivities) * 100).toFixed(0);
                            const label = data.labels[index];
                            
                            // Calculate label position with better spacing
                            const angle = (arc.startAngle + arc.endAngle) / 2;
                            let radius = arc.outerRadius + 40; // Increased distance from chart
                            
                            // Adjust radius based on position to prevent overlaps
                            if (Math.abs(Math.sin(angle)) < 0.5) { // Labels on sides
                                radius += 15;
                            }
                            
                            let x = centerX + Math.cos(angle) * radius;
                            let y = centerY + Math.sin(angle) * radius;
                            
                            // Adjust text alignment based on position
                            let textAlign = 'center';
                            if (Math.cos(angle) > 0.5) {
                                textAlign = 'left';
                                x += 10;
                            } else if (Math.cos(angle) < -0.5) {
                                textAlign = 'right';
                                x -= 10;
                            }
                            
                            // Check for overlaps and adjust position
                            const labelHeight = 16;
                            const labelWidth = ctx.measureText(`${label} ${percentage}%`).width;
                            
                            for (let pos of labelPositions) {
                                if (Math.abs(x - pos.x) < labelWidth + 10 && Math.abs(y - pos.y) < labelHeight + 5) {
                                    // Adjust position to avoid overlap
                                    if (y < centerY) {
                                        y -= labelHeight + 5;
                                    } else {
                                        y += labelHeight + 5;
                                    }
                                }
                            }
                            
                            labelPositions.push({ x, y, width: labelWidth, height: labelHeight });
                            
                            // Set text style
                            ctx.fillStyle = dataset.backgroundColor[index];
                            ctx.font = 'bold 13px Arial';
                            ctx.textAlign = textAlign;
                            ctx.textBaseline = 'middle';
                            
                            // Draw connection line (optional)
                            ctx.strokeStyle = dataset.backgroundColor[index];
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            const lineStartX = centerX + Math.cos(angle) * (arc.outerRadius + 5);
                            const lineStartY = centerY + Math.sin(angle) * (arc.outerRadius + 5);
                            const lineEndX = centerX + Math.cos(angle) * (arc.outerRadius + 25);
                            const lineEndY = centerY + Math.sin(angle) * (arc.outerRadius + 25);
                            ctx.moveTo(lineStartX, lineStartY);
                            ctx.lineTo(lineEndX, lineEndY);
                            ctx.stroke();
                            
                            // Draw the label
                            ctx.fillText(`${label} ${percentage}%`, x, y);
                        });
                    }
                }]
            });
        }

        function renderScoringRules() {
            const container = document.getElementById('scoringRules');
            const rules = [
                { icon: 'mail', description: 'Email opened in last 3 days', points: 10, color: 'text-blue-600' },
                { icon: 'message-circle', description: 'DM activity in last 3 days', points: 15, color: 'text-green-600' },
                { icon: 'calendar', description: 'Booking link clicked', points: 20, color: 'text-purple-600' },
                { icon: 'trending-up', description: 'Social engagement (2+ posts)', points: 8, color: 'text-pink-600' },
                { icon: 'mail', description: 'Email engagement (3+ opens)', points: 12, color: 'text-indigo-600' },
                { icon: 'clock', description: 'Recent activity bonus (24h)', points: 5, color: 'text-orange-600' }
            ];

            container.innerHTML = `
                <div class="grid gap-3">
                    ${rules.map(rule => `
                        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="${rule.icon}" class="w-4 h-4 ${rule.color.replace('text-', 'text-').replace('-600', '-500')}"></i>
                                <span class="font-medium text-gray-900">${rule.description}</span>
                            </div>
                            <span class="font-bold ${rule.color}">+${rule.points}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 mt-4">
                    <h4 class="font-semibold text-gray-900 mb-2">Lead Categories</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span>üî• Hot Leads</span>
                            </span>
                            <span class="font-semibold text-red-600">40+ points</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <span>üü° Warm Leads</span>
                            </span>
                            <span class="font-semibold text-yellow-600">25-39 points</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                                <span>‚ùÑÔ∏è Cold Leads</span>
                            </span>
                            <span class="font-semibold text-gray-600">&lt;25 points</span>
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        function renderLeadCard(lead) {
            return `
                <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 hover:scale-105" data-lead-id="${lead.id}">
                    <div class="h-1 w-full bg-gradient-to-r ${getCategoryGradient(lead.category)} rounded-t-2xl -mt-6 -mx-6 mb-6"></div>
                    
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-2xl bg-gradient-to-r ${getCategoryGradient(lead.category)} shadow-lg">
                                <i data-lucide="${getCategoryIcon(lead.category)}" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">${lead.name}</h3>
                                <p class="text-sm text-gray-600">${lead.email}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold bg-gradient-to-r ${getCategoryGradient(lead.category)} bg-clip-text text-transparent">
                                ${lead.score}
                            </div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">${lead.category}</div>
                        </div>
                    </div>

                    <div class="mb-6 space-y-3">
                        <div class="flex items-center space-x-3 text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
                            <i data-lucide="phone" class="w-4 h-4 text-gray-400"></i>
                            <span class="font-medium">${lead.phone}</span>
                        </div>
                        <div class="flex items-center space-x-3 text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
                            <i data-lucide="clock" class="w-4 h-4 text-gray-400"></i>
                            <span>Last contact: <span class="font-medium">${formatTimestamp(lead.last_contact)}</span></span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="text-sm font-semibold text-gray-700 mb-3 flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span>Suggested Action</span>
                        </div>
                        <div class="text-sm text-blue-700 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                            ${lead.suggested_action}
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold text-gray-700 mb-3 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span>Recent Activities & Scoring</span>
                            </div>
                            <button class="view-history-btn flex items-center space-x-1 text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded-lg transition-colors" data-lead-id="${lead.id}">
                                <i data-lucide="history" class="w-3 h-3"></i>
                                <span>View All</span>
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${lead.recent_activities.slice(0, 3).map((activity, index) => {
                                const scoringContribution = lead.score_breakdown.find(breakdown => 
                                    breakdown.activities.some(scoringActivity => 
                                        scoringActivity.action === activity.action && 
                                        scoringActivity.channel === activity.channel
                                    )
                                );

                                return `
                                    <div class="flex items-center space-x-3 text-sm bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                                        <div class="p-1 bg-gray-100 rounded-lg">
                                            <i data-lucide="${getChannelIcon(activity.channel)}" class="w-4 h-4"></i>
                                        </div>
                                        <span class="flex-1 font-medium text-gray-700">${activity.action.replace(/_/g, ' ')}</span>
                                        ${scoringContribution ? `
                                            <div class="flex items-center space-x-1 bg-green-50 px-2 py-1 rounded-full border border-green-200">
                                                <i data-lucide="plus" class="w-3 h-3 text-green-600"></i>
                                                <span class="text-xs font-bold text-green-600">${scoringContribution.points}</span>
                                            </div>
                                        ` : ''}
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                            ${formatTimestamp(activity.timestamp)}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <h5 class="text-sm font-semibold text-gray-900 mb-2">Score Breakdown</h5>
                            <div class="grid grid-cols-2 gap-2">
                                ${lead.score_breakdown.map(breakdown => `
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-gray-600 truncate">${breakdown.description}</span>
                                        <span class="font-bold text-blue-600">+${breakdown.points}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    ${lead.score >= 40 ? `
                        <div class="mt-6 flex justify-center">
                            <div class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-full text-sm font-bold shadow-lg animate-pulse">
                                <i data-lucide="flame" class="w-4 h-4"></i>
                                <span>HIGH PRIORITY</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderKanbanColumn(category, categoryLeads) {
            const config = {
                hot: { title: 'Hot Leads', icon: 'flame', gradient: 'from-red-500 to-pink-500', bgColor: 'bg-red-50', borderColor: 'border-red-200' },
                warm: { title: 'Warm Leads', icon: 'thermometer', gradient: 'from-yellow-500 to-orange-500', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-200' },
                cold: { title: 'Cold Leads', icon: 'snowflake', gradient: 'from-gray-500 to-slate-500', bgColor: 'bg-gray-50', borderColor: 'border-gray-200' }
            };

            const columnConfig = config[category];
            
            return `
                <div class="kanban-column flex-shrink-0 w-full sm:w-80 lg:w-96" data-category="${category}">
                    <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-4 sm:p-6 h-full flex flex-col">
                        <div class="flex items-center justify-between mb-4 sm:mb-6">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <div class="p-1.5 sm:p-2 bg-gradient-to-r ${columnConfig.gradient} rounded-lg shadow-lg">
                                    <i data-lucide="${columnConfig.icon}" class="w-4 h-4 sm:w-5 sm:h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-base sm:text-lg font-bold text-gray-900">${columnConfig.title}</h3>
                                    <p class="text-xs sm:text-sm text-gray-600">${categoryLeads.length} leads</p>
                                </div>
                            </div>
                            <div class="text-xl sm:text-2xl font-bold bg-gradient-to-r ${columnConfig.gradient} bg-clip-text text-transparent">
                                ${categoryLeads.length}
                            </div>
                        </div>
                        
                        <div class="kanban-drop-zone flex-1 space-y-3 sm:space-y-4 p-3 sm:p-4 rounded-xl ${columnConfig.bgColor} border-2 border-dashed ${columnConfig.borderColor} overflow-y-auto max-h-[600px]" data-category="${category}" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9;">
                            ${categoryLeads.map(lead => `
                                <div class="kanban-card bg-white rounded-xl shadow-lg border border-gray-200 p-3 sm:p-4 cursor-move hover:shadow-xl transition-all duration-200" draggable="true" data-lead-id="${lead.id}">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                                            <div class="p-1.5 sm:p-2 rounded-lg bg-gradient-to-r ${getCategoryGradient(lead.category)} shadow-sm flex-shrink-0">
                                                <i data-lucide="${getCategoryIcon(lead.category)}" class="w-3 h-3 sm:w-4 sm:h-4 text-white"></i>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <h4 class="font-bold text-gray-900 text-sm sm:text-base truncate">${lead.name}</h4>
                                                <p class="text-xs text-gray-600 truncate">${lead.email}</p>
                                            </div>
                                        </div>
                                        <div class="text-right flex-shrink-0 ml-2">
                                            <div class="text-lg sm:text-xl font-bold bg-gradient-to-r ${getCategoryGradient(lead.category)} bg-clip-text text-transparent">
                                                ${lead.score}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-xs text-gray-600 mb-3">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="clock" class="w-3 h-3 flex-shrink-0"></i>
                                            <span class="truncate">Last contact: ${formatTimestamp(lead.last_contact)}</span>
                                        </div>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <i data-lucide="phone" class="w-3 h-3 flex-shrink-0"></i>
                                            <span class="truncate">${lead.phone}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="text-xs text-blue-700 bg-blue-50 p-2 rounded-lg mb-3">
                                        ${lead.suggested_action.substring(0, 60)}${lead.suggested_action.length > 60 ? '...' : ''}
                                    </div>

                                    <div class="border-t border-gray-100 pt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-semibold text-gray-700">Recent Activities</span>
                                            <button class="view-history-btn text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition-colors" data-lead-id="${lead.id}">
                                                <i data-lucide="history" class="w-3 h-3 inline mr-1"></i>View All
                                            </button>
                                        </div>
                                        <div class="space-y-1">
                                            ${lead.recent_activities.slice(0, 2).map(activity => {
                                                const scoringContribution = lead.score_breakdown.find(breakdown => 
                                                    breakdown.activities.some(scoringActivity => 
                                                        scoringActivity.action === activity.action && 
                                                        scoringActivity.channel === activity.channel
                                                    )
                                                );

                                                return `
                                                    <div class="flex items-center space-x-2 text-xs bg-gray-50 p-2 rounded">
                                                        <div class="p-1 bg-white rounded">
                                                            <i data-lucide="${getChannelIcon(activity.channel)}" class="w-3 h-3"></i>
                                                        </div>
                                                        <span class="flex-1 font-medium text-gray-700 truncate">${activity.action.replace(/_/g, ' ')}</span>
                                                        ${scoringContribution ? `
                                                            <div class="flex items-center space-x-1 bg-green-100 px-1 py-0.5 rounded">
                                                                <i data-lucide="plus" class="w-2 h-2 text-green-600"></i>
                                                                <span class="text-xs font-bold text-green-600">${scoringContribution.points}</span>
                                                            </div>
                                                        ` : ''}
                                                        <span class="text-xs text-gray-500 flex-shrink-0">
                                                            ${formatTimestamp(activity.timestamp)}
                                                        </span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>

                                    ${lead.score >= 40 ? `
                                        <div class="mt-3 flex justify-center">
                                            <div class="flex items-center space-x-1 px-2 py-1 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-full text-xs font-bold shadow-lg animate-pulse">
                                                <i data-lucide="flame" class="w-3 h-3"></i>
                                                <span>HIGH PRIORITY</span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLeads() {
            const filteredLeads = leads.filter(lead => {
                const matchesFilter = currentFilter === 'all' || lead.category === currentFilter;
                const matchesSearch = lead.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
                                     lead.email.toLowerCase().includes(currentSearch.toLowerCase());
                return matchesFilter && matchesSearch;
            });

            const gridView = document.getElementById('gridView');
            const kanbanView = document.getElementById('kanbanView');
            const noResults = document.getElementById('noResults');

            if (filteredLeads.length === 0) {
                gridView.innerHTML = '';
                kanbanView.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            } else {
                noResults.classList.add('hidden');
            }

            if (currentView === 'grid') {
                gridView.innerHTML = filteredLeads.map(renderLeadCard).join('');
                kanbanView.classList.add('hidden');
                gridView.classList.remove('hidden');
            } else {
                const hotLeads = filteredLeads.filter(lead => lead.category === 'hot');
                const warmLeads = filteredLeads.filter(lead => lead.category === 'warm');
                const coldLeads = filteredLeads.filter(lead => lead.category === 'cold');

                kanbanView.innerHTML = `
                    <div class="flex flex-col sm:flex-row space-y-6 sm:space-y-0 sm:space-x-4 lg:space-x-6 overflow-x-auto pb-6 min-h-[700px]">
                        ${renderKanbanColumn('hot', hotLeads)}
                        ${renderKanbanColumn('warm', warmLeads)}
                        ${renderKanbanColumn('cold', coldLeads)}
                    </div>
                `;
                
                gridView.classList.add('hidden');
                kanbanView.classList.remove('hidden');
                
                // Add drag and drop functionality
                setupDragAndDrop();
            }

            lucide.createIcons();
            setupEventListeners();
        }

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const dropZones = document.querySelectorAll('.kanban-drop-zone');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.leadId);
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drop-zone');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drop-zone');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drop-zone');
                    
                    const leadId = parseInt(e.dataTransfer.getData('text/plain'));
                    const newCategory = zone.dataset.category;
                    
                    updateLeadCategory(leadId, newCategory);
                });
            });
        }

        function updateLeadCategory(leadId, newCategory) {
            const leadIndex = leads.findIndex(lead => lead.id === leadId);
            if (leadIndex !== -1) {
                const lead = leads[leadIndex];
                const oldCategory = lead.category;
                
                if (oldCategory !== newCategory) {
                    // Update lead category
                    leads[leadIndex].category = newCategory;
                    
                    // Update stats
                    stats[`${oldCategory}_leads`]--;
                    stats[`${newCategory}_leads`]++;
                    
                    // Re-render
                    renderStatsCards();
                    renderLeads();
                    
                    showToast(`${lead.name} moved to ${newCategory} category`, 'success');
                }
            }
        }

        function showActivityHistory(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            const modal = document.getElementById('activityModal');
            const modalLeadName = document.getElementById('modalLeadName');
            const modalContent = document.getElementById('modalContent');

            modalLeadName.textContent = lead.name;
            
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                        <h4 class="text-lg font-bold text-gray-900 mb-4">Score Breakdown</h4>
                        <div class="grid gap-4">
                            ${lead.score_breakdown.map(breakdown => `
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-gray-900">${breakdown.description}</span>
                                        <span class="text-lg font-bold text-blue-600">+${breakdown.points}</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <span class="font-medium">Count:</span> ${breakdown.count} activities
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 pt-4 border-t border-blue-200">
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold text-gray-900">Total Score</span>
                                <span class="text-2xl font-bold bg-gradient-to-r ${getCategoryGradient(lead.category)} bg-clip-text text-transparent">
                                    ${lead.score}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-4">All Activities</h4>
                        <div class="space-y-3">
                            ${lead.recent_activities.map(activity => `
                                <div class="flex items-center space-x-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <div class="p-2 bg-gray-100 rounded-lg">
                                        <i data-lucide="${getChannelIcon(activity.channel)}" class="w-5 h-5 text-gray-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">${activity.action.replace(/_/g, ' ')}</div>
                                        <div class="text-sm text-gray-600">Channel: ${activity.channel}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-gray-900">${formatTimestamp(activity.timestamp)}</div>
                                        <div class="text-xs text-gray-500">${new Date(activity.timestamp).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('show');
            lucide.createIcons();
        }

        function setupEventListeners() {
            // View history buttons
            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const leadId = parseInt(btn.dataset.leadId);
                    showActivityHistory(leadId);
                });
            });
        }

        function initializeApp() {
            // Hide loading, show dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Render initial content
            renderStatsCards();
            renderChannelChart();
            renderScoringRules();
            renderLeads();

            // Setup event listeners
            
            // View mode buttons
            document.getElementById('gridViewBtn').addEventListener('click', () => {
                currentView = 'grid';
                document.getElementById('gridViewBtn').className = 'flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors bg-blue-500 text-white';
                document.getElementById('kanbanViewBtn').className = 'flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors text-gray-600 hover:bg-gray-50';
                renderLeads();
            });

            document.getElementById('kanbanViewBtn').addEventListener('click', () => {
                currentView = 'kanban';
                document.getElementById('kanbanViewBtn').className = 'flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors bg-blue-500 text-white';
                document.getElementById('gridViewBtn').className = 'flex items-center space-x-2 px-4 py-2 text-sm font-medium transition-colors text-gray-600 hover:bg-gray-50';
                renderLeads();
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                showToast('Dashboard refreshed', 'success');
                renderStatsCards();
                renderChannelChart();
                renderLeads();
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.className = 'filter-btn px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 hover:scale-105';
                    });
                    btn.className = 'filter-btn active px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg transform scale-105';
                    
                    currentFilter = btn.dataset.filter;
                    renderLeads();
                });
            });

            // Search input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                currentSearch = e.target.value;
                renderLeads();
            });

            // Modal close
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('activityModal').classList.remove('show');
            });

            // Close modal on backdrop click
            document.getElementById('activityModal').addEventListener('click', (e) => {
                if (e.target.id === 'activityModal') {
                    document.getElementById('activityModal').classList.remove('show');
                }
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate loading time
            setTimeout(initializeApp, 1000);
        });
    </script>
</body>
</html>